    {% extends "base.html" %}
    {% block title %}Django ExtJs samples{% endblock %}
    {% block extrahead %}

        <!-- includes from apps -->
        {% for css in APPS_CSS_INCLUDES %}
            <link rel="stylesheet" type="text/css" href="{{ css }}" />
        {% endfor %}
        
        
<!-- 
        <script type="text/javascript" src="/apps/main/static/syntaxhighlighter/scripts/shCore.js"></script>
        <script type="text/javascript" src="/apps/main/static/syntaxhighlighter/scripts/shBrushJScript.js"></script>
        <script type="text/javascript" src="/apps/main/static/syntaxhighlighter/scripts/shBrushPython.js"></script>
        
        <link href="/apps/main/static/syntaxhighlighter/styles/shCore.css" rel="stylesheet" type="text/css" />
        <link href="/apps/main/static/syntaxhighlighter/styles/shThemeDefault.css" rel="stylesheet" type="text/css" />
        
  -->
    
    {% endblock %}
    
    {% block content %}

        <!-- LOADING MASK -->
        
        <!--
        <div id="loading-mask"></div>
        <div id="loading">
          <div class="loading-indicator">
            <div>
              <img src="http://extjs.cachefly.net/ext-3.1.0/resources/images/default/shared/large-loading.gif" width="32" height="32" style="margin-right:8px;" align="absmiddle"/>Loading ...
            </div>
          </div>
        </div>
        -->
 
    <!-- ExtJS library -->
	{% if debug %}
        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.1.0/ext-all-debug.js"></script>
        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.1.0/examples/ux/ux-all-debug.js"></script>
    {% else %}
        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.1.0/ext-all.js"></script>
        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.1.0/examples/ux/ux-all.js"></script>
    {% endif %}
    
    <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.1.0/src/locale/ext-lang-fr.js"></script>
 
    <!-- Librerias locales, se cargaron directamente en la pagina    -->
    <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.AutoEditableGrid.js"></script> 
<!--     <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.AutoGrid.js"></script>  -->
    <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.AutoGridPanel.js"></script> 
    <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.DateTime.js"></script> 
<!--     <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.DjangoForms.js"></script>  -->
    <script type="text/javascript" src="/apps/django_extjs/static/js/Ext.ux.DynamicGridPanel.js"></script> 
  
   
     <script language="javascript">
       if(window.console && window.console.dir){ 
            // firebug detected
            console.log("FireBug detected. Please disable to improve performance");
       }
       else {
            var console = {
                'log':function(){}
            };
       }
       
       // dev tool : dynamic reload a JS
       function load_src(src) {
            var DSLScript  = document.createElement("script");
            DSLScript.src  = src;
            DSLScript.type = "text/javascript";
            document.body.appendChild(DSLScript);
            document.body.removeChild(DSLScript);
            //console.log('loaded ' + src);
        }

//  -----------------------------------------------------

    
Ext.ux.AutoGrid = Ext.extend(Ext.ux.AutoGridPanel, {
     showBbar:false
    ,stripeRows:true
    ,deferredRender :true
    ,autoSave:false
    ,remoteSort:true
    ,sortInfo:{}
    // ,sm:new Ext.grid.RowSelectionModel({})
    // ,reader: new Ext.data.JsonReader({
            // root:'rows'
            // ,id:'id'
     // })
    ,initComponent:function() {
        this.pagesize = this.pagesize || 10;
        
        if (this.showBbar) this.bbar = new Ext.PagingToolbar({
                pageSize: this.pagesize,
                store:  this.store,
                displayInfo: true,
                displayMsg: '{0} à {1} sur {2}',
                emptyMsg: "Aucun élément à afficher"
        });
        
        var config = {  
            store:  this.store
            ,stripeRows: true
            ,loadMask: true
            ,autoSave: this.autoSave
        };
        Ext.apply(this.initialConfig, config);
        Ext.ux.AutoGrid.superclass.initComponent.apply(this, arguments);

    } 

 
}); 

            
Ext.reg('AutoGrid', Ext.ux.AutoGrid); 
        

        
//  -----------------------------------------------------

// dynamic load of a server side form

Ext.ux.DjangoForm = Ext.extend(Ext.FormPanel, {
 
        url:null
        ,baseParamsLoad:null
        ,callback:null
        ,scope:null
        
        ,border:false
        ,custom_config:null
        ,default_config:null
        ,showButtons:true
        ,showSuccessMessage:'Formulaire bien enregistre'
        
        ,initComponent:function() {
            if (this.showButtons) {
                this.buttons = [
                     {name:'submit', xtype:'button', iconCls:'icon-accept', text:'enregistrer', scope:this, handler:function(args) {this.submitForm();}}
                    ,{name:'reset', xtype:'button', iconCls:'icon-cancel', text:'reset',  scope:this, handler:function(args) {this.resetForm();}}
                ]
                }
                
                this.items = {border:false, 'html':'<img style="vertical-align:middle" src="http://extjs.cachefly.net/ext-3.1.0/resources/images/default/shared/large-loading.gif"/>&nbsp;&nbsp;&nbsp;&nbsp;loading...'}
                    this.getDefaultButton = function(name) {
                    
                    }
                    this.gotFormCallback = function(response, options) {
                        
                         var res = Ext.decode(response.responseText);
                         this.default_config = res;

                            this.removeAll();
   
                             if (this.custom_config) {
                                // add custom form config to this formpanel
                        var newconf = this.custom_config.createDelegate(this, [this])();
                        for (var i=0;i<newconf.items.length;i++) {
                            this.add(Ext.ComponentMgr.create(newconf.items[i]));
                        }
                        
                        // auto add hidden fields from django form if needed
                            for (var i=0;i<this.default_config.length;i++) {
                                if (this.default_config[i].xtype == 'hidden') {
                                   this.add(Ext.ComponentMgr.create(this.default_config[i]));
                                }
                            }
                                //this.default_config = res;
                    }
                    else {
                        
                        if (this.intro) {
                            this.add({html:this.intro, style:'padding-bottom:10px;padding-top:10px;font-size:14px', border:false});
                        }
                        if (this.startItems) {
                            this.add(this.startItems);
                        }
                        
                      //  Ext.apply(this, this.default_config);
                         
                        for (var i=0;i<res.length;i++) {
                            this.add(Ext.ComponentMgr.create(res[i]));
                        }
                    }
                    //finally callback your function when ready
                   if (this.callback) {
                      this.callback.createDelegate(this.scope, [this])();
                    }
             }
             
             var o = {}
             if (this.baseParamsLoad) Ext.apply(o, this.baseParamsLoad);

                Ext.ux.DjangoForm.superclass.initComponent.apply(this, arguments);
                 
                 this.addEvents('submitSuccess', 'submitError');
                 
             Ext.Ajax.request({
                url:this.url
                ,params:o
                ,method:'GET'
                ,scope:this
                ,success:this.gotFormCallback
                ,failure:this.gotFormCallback
            });
            
            
           
        }
      ,submitSuccess:function() {
             this.fireEvent('submitSuccess');
             if (this.showSuccessMessage) {
                 Ext.Msg.show({
                   title:'Succes',
                   msg: this.showSuccessMessage,
                   buttons: Ext.Msg.OK,               
                   icon: Ext.MessageBox.INFO 
                });
           }
        }
        ,submitError:function(msg) {
        
                this.fireEvent('submitError', msg);
                Ext.Msg.show({
                       title:'Erreur',
                       msg: 'Impossible de valider : <br>' + msg + '<br>',
                       buttons: Ext.Msg.OK,               
                       icon: Ext.MessageBox.WARNING 
                    });
        }
        
        ,validResponse:function(form, action) {
                for (btn in this.buttons) {
                    var butt = this.buttons[btn];
                    if (butt.name == 'submit') butt.enable();
                }
               if (action && action.result && action.result.success) {
                   this.submitSuccess();
               }
               else {
                    this.submitError(action && action.result && action.result.msg || 'erreur');
                    
               }
               
        }
        ,invalid:function() {
        //    console.log('invalid: ', this.getForm().getValues());
             Ext.Msg.show({
               title:'Erreur',
               msg: 'Impossible de valider : formulaire invalide',
               buttons: Ext.Msg.OK,               
               icon: Ext.MessageBox.WARNING 
            });
        }
        ,resetForm:function() {
            console.log('resetForm');
            this.getForm().reset();
        }
        
        ,submitForm:function() {
            //console.log('submitForm');
            if (this.getForm().isValid()) {
                for (btn in this.buttons) {
                    if (this.buttons[btn].name == 'submit') {
                        this.buttons[btn].disable();
                        }
                }
                this.getForm().submit({scope:this, success:this.validResponse,failure:this.validResponse});
            } else {
                // console.log('invalid form!');
                 // var items = this.getForm().items.items;
                // for (f in items) {
                    // console.log(f, items[f], items[f].isValid());
                // }
                        this.invalid()
                        }
                   }                      
                
             });
             
Ext.ux.DjangoField = function(config) {
            //  console.log(config);
  //         console.log(this);
        var items = config.django_form.default_config;
        
        for (var i=0;i<items.length;i++) {
            if (items[i].name == config.name) {
                
                var bConfig = items[i];
                // prevent infinite loop
                
                if (config.xtype2) {
                    config.xtype = config.xtype2
                    }
               else {
                delete config.xtype
               }
              
                Ext.apply(bConfig, config);
              // console.log(bConfig); 
                
                return Ext.ComponentMgr.create(bConfig);     
                }
        }
}
 

 
Ext.reg("DjangoForm", Ext.ux.DjangoForm);
Ext.reg("DjangoField", Ext.ux.DjangoField);
         
// ---------------------------------------------------------------------        
 
        
function GridConfigFactory(version) {

           
            var users_grid = new Ext.ux.AutoGrid({
                autoWidth:true
                ,border:false
                ,pagesize:5
                ,tbar:[
                    new Ext.Button({
                        text:'add new user'
                        ,iconCls:'icon-user_add'
                        ,scope:this
                        ,handler:function() {
                            
                            UserEditor(arguments[0].findParentByType('AutoGrid'), '');
                        }
                    })
                ]
                ,forceFit:false
                ,stripRows:true
                ,showBbar:true
                ,loadMask:true
                ,sm:new Ext.grid.RowSelectionModel({})
                ,store:new Ext.data.JsonStore({
                    autoLoad:true
                    ,baseParams:{}
                    ,remoteSort:true
                    ,sortInfo: {
                                field: 'id',
                                direction: 'DESC'
                            }
                    ,proxy:new Ext.data.HttpProxy({
                        url:'apps/main/users_grid/' + version
                        ,method:'POST'
                    })
                    ,reader: new Ext.data.JsonReader({
                        root:'rows'
                        ,id:'id'
                    })

                })
            });
            
            return users_grid;
        
        }

function UserEditor(sender, pk) {
          var editor = new Ext.ux.DjangoForm({
                border:false
                ,intro:'this is a generated form'
                ,showButtons:true
                ,showSuccessMessage:false
                ,url:'apps/main/user_edit' 
                ,baseParamsLoad:{pk:pk}
                ,width:400
                ,scope:this
                 ,callback:function(form) {
                    //console.log(form, this, editor);
                    form.doLayout();
                    form.findParentByType('window').center();
                 }
           });

           var winEditor = new Ext.Window({
            items:editor
            ,title:'generated form example'
           })
           
             editor.on('submitSuccess', function() {
                //console.log('success', this, arguments);
                        if (sender) sender.store.reload();
                        if (winEditor && winEditor.isVisible()) {
                            winEditor.close();
                            winEditor.destroy();
                        }

                    }, sender || this);
           
           winEditor.show();
        }
        
//  --------------------------------------------

    
Ext.ux.AutoEditableGrid = Ext.extend(Ext.ux.AutoGrid, {
     showToolbar:true
     ,url:''
     ,remoteSort:true
     ,sortInfo:{}
    ,initComponent:function() {
    
            this.store = new Ext.data.JsonStore({
                    autoLoad:true
                    ,baseParams:{}
                    ,remoteSort:this.remoteSort
                    ,sortInfo:this.sortInfo
                    ,proxy:new Ext.data.HttpProxy({
                        url:this.url
                        ,method:'POST'
                    })
                    ,reader: new Ext.data.JsonReader({
                        root:'rows'
                        ,id:'id'
                    })

                })
     //   console.log('initComponent AutoEditableGrid', this.sortInfo, this.store.sortInfo);
        this.GridCheckboxes = new Ext.grid.CheckboxSelectionModel();
        this.sm = this.GridCheckboxes;
	    this.plugin = this.GridCheckboxes;
 
        this.btn_new = new Ext.Button({
                        text:'add new'
                        ,iconCls:'icon-user_add'
                        ,scope:this
                        ,handler:function() {
                          this.addRow();
                        }
                        
                    });
        this.addRow = function() {
                initial = {}
                var myStore = this.getStore();
                var r = new myStore.recordType(initial, 0); 
                myStore.insert(0, r);  
                this.startEditing(0, 2);
        }
        this.btn_delete = new Ext.Button({
                        text:'delete'
                        ,iconCls:'icon-user_delete'
                        ,scope:this
                        ,handler:function() {
                         //   alert('del');
                            var records = this.getSelectionModel().getSelections();
                            dels = [];
                            Ext.each(records, function(item, index, all) {
                                dels.push(item.id);
                            },this);
 
                         //   console.log(dels);
                            var sure = confirm("Sure to delete these "+ dels.length + " items ?");
                            
                            if (dels.length > 0 ) {
                                Ext.Ajax.request({
                                   url: this.store.proxy.url,
                                   method :'POST',
                                   callback : function(options, success, response) {
                                        json  = Ext.decode(response.responseText);
                                        if (!success || !json.success) {
                                            alert("Erreur : " + json.msg);
                                        }
                                        else{
                                            // this.btn_save.stopBlink();
                                            // this.btn_save.disable();
                                            // this.getStore().commitChanges();
                                            this.getStore().reload();
                                            }
                                   },
                                   scope: this,
                                   params: { 'delete': dels.join(',')}
                                })
                            }
                        }
                    });
        this.btn_save = new Ext.Button({
                        text:'save'
                        ,disabled:true
                        ,iconCls:'icon-disk'
                        ,scope:this
                        ,handler:function() {
                            var modified = this.getStore().getModifiedRecords();
                            var mod = []
                           Ext.each(modified, function(item, index, all) {
                                    a = {}
                                    a.id = item.id
                                    Ext.apply(a, item.getChanges());
                                    mod.push(a);
                                },this);
                            
                            Ext.Ajax.request({
                               url: this.store.proxy.url,
                               method :'POST',
                               callback : function(options, success, response) {
                                    json  = Ext.decode(response.responseText);
                                    if (!success || !json.success) {
                                        alert("Erreur : " + json.msg);
                                    }
                                    else{
                                        
                                        this.getStore().commitChanges();
                                        this.getStore().reload();
                                        this.btn_save.stopBlink();
                                        this.btn_save.disable();
                                        }
                               },
                               scope: this,
                               params: { update: Ext.encode(mod)}
                            });
                        }
                        ,counter:0
                        ,blinking:false
                        ,task_blink:{
                            run: function(){
                                if (!this.btn_save) return;
                                nclass = (this.btn_save.counter%2==0)?'icon-disk-red':'icon-disk';
                                this.btn_save.setIconClass(nclass);
                                this.btn_save.counter+=1;
                            },
                            scope:this,
                            interval: 500 
                        }
                        ,startBlink:function(e) {
                             if (this.blinking) return;
                         //    console.log('startBlink', this.task_blink);
                             this.enable();
                             Ext.TaskMgr.start(this.task_blink);
                             this.blinking = true;
                        }
                        ,stopBlink:function(e) {
                           // console.log('stopblink', this.task_blink);
                            Ext.TaskMgr.stop(this.task_blink);
                            this.setIconClass('icon-disk');
                            this.blinking = false;
                        }
                    });
                    
        if (this.showToolbar) this.tbar = [
                    this.btn_new
                    ,this.btn_delete
                    ,this.btn_save       
        ];
        
        Ext.ux.AutoEditableGrid.superclass.initComponent.apply(this, arguments);
        
        this.on('afteredit', function(e) {
            this.btn_save.startBlink();
            }, this);
        
        this.on('beforedestroy', function(e) {
            this.btn_save.stopBlink();
            return true;
            }, this);
    } 
 
}); 


            
Ext.reg('AutoEditableGrid', Ext.ux.AutoEditableGrid); 

 
// ------------------------------------------
        
Ext.onReady(function() {

           Ext.QuickTips.init();
        
            function example1(title) {
                 var simplegrid = GridConfigFactory('');
                 var p = new Ext.Window({
                    width:600
                    ,layout:'fit'
                    ,height:300
                    ,items:simplegrid
                     ,draggable :true
                     ,title:title
                }).show();
            }
            
            function example2(title) {
               var customgrid = GridConfigFactory('custom');
               var p2 = new Ext.Window({
                    title:title
                    ,width:600
                    ,layout:'fit'
                    ,height:300
                    ,items:customgrid
                     ,draggable :true
                    }).show();
                }
           
           function example3(title) {    
           
              var p3 = new Ext.Window({
                width:300
                ,layout:'fit'
                ,height:300
                ,title:title
                ,items:new Ext.ux.DjangoForm({
                        border:false
                        ,intro:'generated contact form'
                        ,showButtons:true
                        ,showSuccessMessage:'Form submission success'
                        ,url:'apps/main/contact_form' 
                        ,scope:this
                         ,callback:function(form) {
                            form.doLayout();
                         }
                   })
                 ,draggable :true
                 
            }).show();
           }
           
           function example4(title) {
                 var editablegrid1 = new Ext.ux.AutoEditableGrid({
                    url:'apps/main/customer_grid' 
                    ,remoteSort:false
                });
                
                var p4 = new Ext.Window({
                    width:700
                    ,layout:'fit'
                    ,height:400
                    ,items:editablegrid1
                    ,draggable :true
                    ,title:title
                     
                }).show();
           }
           
           
          function example5(title) {
                  var p3 = new Ext.Window({
                    width:500
                    ,layout:'fit'
                    ,height:400
                    ,title:title
                    ,items:new Ext.ux.DjangoForm({
                            border:false
                            ,intro:'generated customer form'
                            ,showButtons:true
                            ,showSuccessMessage:'Form submission success'
                            ,url:'apps/main/customer_edit' 
                            ,scope:this
                            ,labelWidth:200
                             ,callback:function(form) {
                                form.doLayout();
                             }
                       })
                     ,draggable :true
                     
                }).show();
                }
           
            var ExamplePanel = function(title, html, example) {
                var b = example && [
                        new Ext.Button({
                             text:'launch this example'
                            ,iconCls:'icon-application_form_magnify'
                            ,scope:this
                            ,handler: function() { example(title); }
                            })
                    ] || [];
                var panel = new Ext.Panel({
                    title:title
                    ,iconCls:'icon-application_view_list'
                    ,width:1200
                    ,style:'margin-top:20px'
                    ,frame:true
                    ,html:html
                    
                    ,buttons:b
                    ,buttonAlign:'left'
                    ,renderTo:'examples'
                });
                return panel
            
            }
            
            
            ExamplePanel('Django ExtJs Samples', Ext.get('intro').dom.innerHTML );
            ExamplePanel('simple generic grid from model', Ext.get('example1').dom.innerHTML , example1);
            ExamplePanel('custom grid from model', Ext.get('example2').dom.innerHTML, example2);
            ExamplePanel('Editable grid example', Ext.get('example4').dom.innerHTML, example4);
            ExamplePanel('Simplest form example', Ext.get('example3').dom.innerHTML, example3);
            ExamplePanel('Simplest ModelForm example', Ext.get('example5').dom.innerHTML, example5);
             
            //ExamplePanel('Custom editable grid from model', 'This is a grid generated from a django queryset, but customised, and you can edit directly', p5);
                
        });
        
//          SyntaxHighlighter.all()
        
    </script>
    <script language="javascript">
        Ext.BLANK_IMAGE_URL = "http://extjs.cachefly.net/ext-3.1.0/resources/images/default/s.gif";
    </script>
    <style>
/*    pre {
        font-size:10px !important;
        font-family:Trebuchet Ms;
        border:1px solid navy;
        padding:5px;
        background:white !important;
    } */
    </style>
    
    <!-- includes from apps -->
    {% for js in APPS_JS_INCLUDES %}
        <script type="text/javascript" src="{{ js }}"></script>
    {% endfor %}
    
    <div id='generic_grid'></div>
    
    <div id='examples' style='margin:0 50 0 50'></div>
  
    <div id='intro' style='display:none'>
    This is the main django-extjs demo page. The main repo is here : <a href='http://github.com/revolunet/django-extjs'>http://github.com/revolunet/django-extjs</a>.
    <br><br>
    A full working application example with source code is available at  <a href='http://github.com/revolunet/django-skeleton/tree/extjs'>django-skeleton extjs sample project</a>.
    <br><br>
    django-extjs helps you generate ExtJs forms and grids from django.
    
    <br><br>
    Samples includes Model Grids, editables grids, forms and modelforms.
    <br><br>
    This demo uses <a href="http://www.extjs.com">ExtJs</a> 3.1 and <a href="www.djangoproject.com">Django</a> 1.1 and has been created by the <a href="http://www.revolunet.com">revolunet</a> team.
    </div>
    
    
    <div id='example1' style='display:none'>
        This is a simple grid generated from a django queryset.<br><br>
        in your views.py (maps to /apps/main/users_grid) :<br>
        <pre  class="brush: python" >
        from django.contrib.auth.models import User
        from apps.django_extjs import grids, utils
        
        def users_grid(request):
            grid = grids.ModelGrid(User) 
            users = User.objects.all()
            json = grid.to_grid(users, sort_field = 'id', sort_direction = 'ASC')    
            return utils.JsonResponse(json)</pre>
        in your html :<br>
        
        <pre class="brush: js" >
        var users_grid = new Ext.ux.AutoGrid({
            autoWidth:true
            ,pagesize:5
            ,forceFit:false
            ,store:new Ext.data.JsonStore({
                autoLoad:true
                ,remoteSort:true
                ,proxy:new Ext.data.HttpProxy({
                    url:'/apps/main/users_grid/'
                    ,method:'POST'
                })
                ,reader: new Ext.data.JsonReader({
                    root:'rows'
                    ,id:'id'
                })
            })
        }); </pre>
    </div>
    
    
      <div id='example2' style='display:none'>
        This is also a simple grid generated from a django queryset.<br><br>
        But the columns are customised with some server side config.<br><br>
        The default columnModel can also be overriden by the server (per user for example).<br><br>
        in your views.py (maps to /apps/main/custom_user_grid) :<br>
        <pre class="brush: python" >

        from django.contrib.auth.models import User
        from apps.django_extjs import grids, utils
        
        # your custom grid, just defines the fields configuration
        class CustomGridUsers(grids.ModelGrid):
            class Meta:
                exclude = []
                # set fields we want to display
                order = ['id', 'username', 'email', 'is_staff', 'is_active', 'is_superuser', 'last_login', 'date_joined']
                # customise the fields if needed
                fields_conf = {}
                fields_conf['id'] = {'hidden':True, 'width':30, 'align':'center'}
                fields_conf['last_login'] = {'type':'date', 'header':u'last_login', 'width':90,  'dateFormat':'d/m/Y', 'renderer':"new Ext.util.Format.dateRenderer('d/m/Y')", 'align':'center'}
                fields_conf['date_joined'] = {'type':'date', 'header':u'date_joined', 'width':90,  'dateFormat':'d/m/Y', 'renderer':"new Ext.util.Format.dateRenderer('d/m/Y')", 'align':'center'}
                # fields_conf['email'] = {'width':150}
                fields_conf['is_staff'] = {'width':50, 'header':'staff', 'align':'center', 'renderer':"function(val, attr) {attr.css = (val)?'icon-accept':'icon-delete'; }"}
                fields_conf['is_active'] = {'width':50, 'header':'active', 'align':'center', 'renderer':"function(val, attr) {attr.css = (val)?'icon-accept':'icon-delete'; }"}
                fields_conf['is_superuser'] = {'width':50, 'header':'root', 'align':'center', 'renderer':"function(val, attr) {attr.css = (val)?'icon-accept':'icon-delete'; }"}

        
        # your view
        def custom_user_grid(request):
            grid = CustomGridUsers(User) 
            users = User.objects.all()
            json = grid.to_grid(users, sort_field = 'id', sort_direction = 'ASC')        
            return utils.JsonResponse(json) </pre>
        in your html :<br>
        <pre class="brush: js" >
        var custom_user_grid = new Ext.ux.AutoGrid({
            autoWidth:true
            ,pagesize:5
            ,forceFit:false
            ,store:new Ext.data.JsonStore({
                autoLoad:true
                ,remoteSort:true
                ,proxy:new Ext.data.HttpProxy({
                    url:'/apps/main/custom_user_grid'
                    ,method:'POST'
                })
                ,reader: new Ext.data.JsonReader({
                    root:'rows'
                    ,id:'id'
                })
            })
        }); </pre>
    </div>
 
 
     
   
   
    <div id='example3' style='display:none'>
    This is a simple django generated contact form rendered as ExtJs. <br><br>
    Validation is done client-side (required, choices, vtypes...) but also server side. Django handles submission like any other django form.<br><br>
    Your form could also be generated directly from a Model as described later<br><br>
    in your views.py (maps to /apps/main/users_grid) :<br>
    <pre class="brush: python" >
        from apps.django_extjs import forms as extforms, utils
        
        class ContactForm(forms.Form):
            name = forms.CharField(label='your name')
            phone = forms.CharField(label='phone number', required = False)
            mobile_type = forms.CharField(label='phone type', required = True)
            mobile_type.choices = [
                 ('ANDROID','Android')
                ,('IPHONE','iPhone')
                ,('SYMBIAN','Symbian (nokia)')
                ,('OTHERS','Others')
            ]
            email = forms.EmailField(label='your email', initial='test@revolunet.com')
            message = forms.CharField(label='your message', widget = forms.widgets.Textarea(attrs={'cols':15, 'rows':5}))

        extforms.ExtJsForm.addto(ContactForm)    # adds some magic
                
        # your view
        def contact_form(request):
            if request.method == 'POST':
                # handle form submission
                form = ContactForm(request.POST)
                if not form.is_valid():
                    return utils.JsonError(form.html_errorlist())
                else:
                    # send your email here
                    print 'send a mail'
                return utils.JsonResponse("{success:true, messages: [{iconCls:'icon-accept', message:'Enregistrement OK'}]}" )
            else:
                # handle form display
                form = ContactForm()
                return utils.JsonResponse(utils.JSONserialise(form.as_extjsfields()))</pre>
      in your html :<br>
        <pre class="brush: js" >
          var p3 = new Ext.Window({
            width:300
            ,layout:'fit'
            ,height:300
            ,items:new Ext.ux.DjangoForm({
                    border:false
                    ,intro:'generated contact form'
                    ,showButtons:true
                    ,showSuccessMessage:'Form submission success'
                    ,url:'apps/main/contact_form' 
                    ,scope:this
                     ,callback:function(form) {
                        form.doLayout();
                     }
               })
             ,draggable :true
            });
            p3.show(); </pre>
    </div>
    
    
    
    <div id='example4' style='display:none'>
        This is another grid generated from a django queryset, but from a custom model (Customer). this model use various fields : dates/numeric/foreignkeys...<br><br>
        You can edit rows in-place, and add or remove rows in the grid.<br><br>
        the example models.py :<br>
        <pre class="brush: python" >
        
        # this is just a dumb model for exercice
        
        from django.db import models

        LIST_TYPES = [
            ('OWNER','Owner')
            ,('RENTER','Renter')
            ,('GUEST','Guest')
            ,('TESTER','Tester')

        ]
        GENDER_CHOICES = (
                ('M', 'Male'),
                ('F', 'Female'),
            )
            
        class Car(models.Model):
            brand = models.CharField(max_length=50, verbose_name="Car brand", help_text="Fill the car brand")
            model = models.CharField(max_length=50, verbose_name="Car model", help_text="Fill the car model")
            
        class Customer(models.Model):
            
            date = models.DateField(auto_now = True, verbose_name="Date modified")
            datetime = models.DateTimeField(auto_now = True, verbose_name="DateTime modified")
            
            last_seen = models.DateField(verbose_name="Last Date customer went in store", help_text="This is mandatory !")
            last_datetime = models.DateTimeField(verbose_name="dateTimeTest", blank=True, null=True)
            last_call_hour = models.TimeField(verbose_name="Last Hour customer was reacheable by phone", blank = True, null = True)
            
            gender = models.CharField(max_length=10, choices = GENDER_CHOICES)
            name = models.CharField(max_length=50)
            email = models.EmailField()
            ctype = models.CharField(max_length=10, choices = LIST_TYPES, verbose_name="Customer type", help_text="This is mandatory !")
            car = models.ForeignKey(Car, blank=True, null=True, verbose_name="Customer car if any")
            
            is_vip = models.BooleanField(default = False)
            
            balance = models.FloatField(verbose_name='Customer balance', default = 0)
        </pre>
        in your views.py (maps to /apps/main/customer_grid) :<br>
        <pre class="brush: python" >
        from apps.django_extjs import grids, utils
        
        def customer_grid(request):
            from models import Customer
            grid = grids.EditableModelGrid(Customer) 
            # you can use POST data to update your instances.
            if request.method == 'POST':
                # handle save of grid data !
                if request.POST.get('delete', '')!='':
                    # delete selected rows
                    dels = request.POST['delete'].split(',')
                    Customer.objects.filter(id__in = dels).delete()
                    return utils.JsonSuccess()
                if request.POST.get('update', '')!='':    
                    # update rows data (update+inserts)
                    try:
                        grid.update_instances_from_json(request.POST['update'])
                        return utils.JsonSuccess()
                    except:
                        #print "Unexpected error:", sys.exc_info()[0]
                        msg = getattr(sys.exc_info()[1], 'message', sys.exc_info()[0])
                        #.message
                        return utils.JsonError(str(msg))
            # display the grid
            users = Customer.objects.all()
            json = grid.to_grid(users)    
            return utils.JsonResponse(json)</pre>
        in your html :<br>
        <pre class="brush: js" >
            var editablegrid2 = new Ext.ux.AutoEditableGrid({
                url:'apps/main/customer_grid' 
                ,remoteSort:false
                ,sortInfo: {
                    field: 'id',
                    direction: 'DESC'
                }
            });</pre>
    </div>
      
    <div id='example5' style='display:none'>
        This an example of a generated ModelForm.<br><br>
        It uses the sample 'Customer' model.<br><br>
        in your views.py (maps to /apps/main/customer_edit) :<br>
        <pre class="brush: python" >
        from apps.django_extjs import utils
        from apps.django_extjs.forms import getExtJsModelForm
        
        def customer_edit(request):
            from models import Customer
            formclass = getExtJsModelForm(Customer)         # get the model form dynamicaly
            form = formclass()                              # instantiate blank form
            if request.method == 'POST':
                id = request.POST.get('id', None)
                instance = Customer()
                # create a new Customer if no id given
                if id:
                    instance = Customer.objects.get(id = id)
                # valid the form with POST data
                form = formclass(request.POST, instance = instance)
                if not form.is_valid():
                    # returns any error message
                    return utils.JsonError(form.html_errorlist())
                else:
                    # save instance
                    form.save()
                    return utils.JsonSuccess()
            
            # hide django auto-added first combo items ('------') wtf
            form.fields['gender'].choices = form.fields['gender'].choices[1:]
            form.fields['type'].choices = form.fields['type'].choices[1:]
            
            # return the form as ExtJs
            return utils.JsonResponse(utils.JSONserialise(form.as_extjsfields()))</pre>
        in your html :<br>
        <pre class="brush: js" >
            var p3 = new Ext.Window({
                width:500
                ,layout:'fit'
                ,height:300
                ,title:title
                ,items:new Ext.ux.DjangoForm({
                        border:false
                        ,intro:'generated customer form'
                        ,showButtons:true
                        ,showSuccessMessage:'Form submission success'
                        ,url:'apps/main/customer_edit' 
                        ,scope:this
                        ,labelWidth:200
                         ,callback:function(form) {
                            form.doLayout();
                         }
                   })
                 ,draggable :true
                 
            }).show();</pre>
    </div>
     
    
    {% endblock %}
